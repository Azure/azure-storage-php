<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

/**
 * LICENSE: The MIT License (the &quot;License&quot;)
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * https://github.com/azure/azure-storage-php/LICENSE
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * PHP version 5
 *
 * @category  Microsoft
 * @package   MicrosoftAzure\Storage\Table\Internal
 * @author    Azure Storage PHP SDK &lt;dmsh@microsoft.com&gt;
 * @copyright 2016 Microsoft Corporation
 * @license   https://github.com/azure/azure-storage-php/LICENSE
 * @link      https://github.com/azure/azure-storage-php
 */
 
namespace MicrosoftAzure\Storage\Table\Internal;

use MicrosoftAzure\Storage\Common\Internal\Resources;
use MicrosoftAzure\Storage\Common\Internal\Utilities;

/**
 * Reads and writes MIME for batch API.
 *
 * @ignore
 * @category  Microsoft
 * @package   MicrosoftAzure\Storage\Table\Internal
 * @author    Azure Storage PHP SDK &lt;dmsh@microsoft.com&gt;
 * @copyright 2016 Microsoft Corporation
 * @license   https://github.com/azure/azure-storage-php/LICENSE
 * @link      https://github.com/azure/azure-storage-php
 */
class MimeReaderWriter implements IMimeReaderWriter
{
    /**
     * Given array of MIME parts in raw string, this function converts them into MIME
     * representation.
     *
     * @param array $bodyPartContents The MIME body parts.
     *
     * @return array Returns array with two elements 'headers' and 'body' which
     * represents the MIME message.
     */
    public function encodeMimeMultipart(array $bodyPartContents)
    {
        $count         = count($bodyPartContents);
        $mimeType      = Resources::MULTIPART_MIXED_TYPE;
        $batchGuid     = Utilities::getGuid();
        $batchId       = sprintf('batch_%s', $batchGuid);
        $contentType1  = array('content_type' =&gt; &quot;$mimeType&quot;);
        $changeSetGuid = Utilities::getGuid();
        $changeSetId   = sprintf('changeset_%s', $changeSetGuid);
        $contentType2  = array('content_type' =&gt; &quot;$mimeType; boundary=$changeSetId&quot;);
        $options       = array(
            'encoding'     =&gt; 'binary',
            'content_type' =&gt; Resources::HTTP_TYPE
        );
        
        $eof = &quot;\r\n&quot;;
        
        $result            = array();
        $result['body']    = Resources::EMPTY_STRING;
        $result['headers'] = array();
        
        $batchBody         =&amp; $result['body'];
        $batchHeaders      =&amp; $result['headers'];
        
        $batchHeaders['Content-Type'] = $mimeType . &quot;; $eof boundary=\&quot;$batchId\&quot;&quot;;
        
        $batchBody .= &quot;--&quot; . $batchId . $eof;
        $batchBody .= &quot;Content-Type: $mimeType; boundary=\&quot;$changeSetId\&quot;&quot; . $eof;
        
        $batchBody .= $eof;
        for ($i = 0; $i &lt; count($bodyPartContents); $i++) {
            $batchBody .= &quot;--&quot; . $changeSetId . $eof;
            
            $batchBody .= &quot;Content-Transfer-Encoding: binary&quot; . $eof;
            $batchBody .= &quot;Content-Type: &quot; . Resources::HTTP_TYPE . $eof;
            
            $batchBody .= $eof . $bodyPartContents[$i] . $eof;
        }
        $batchBody .= &quot;--&quot; . $changeSetId . &quot;--&quot; . $eof;
        $batchBody .= $eof;
        $batchBody .= &quot;--&quot; . $batchId . &quot;--&quot; . $eof;

        return $result;
    }
    
    /**
     * Parses given mime HTTP response body into array. Each array element
     * represents a change set result.
     *
     * @param string $mimeBody The raw MIME body result.
     *
     * @return array
     */
    public function decodeMimeMultipart($mimeBody)
    {
        // Find boundary
        $boundaryRegex = '~boundary=(changesetresponse_.*)~';
        preg_match($boundaryRegex, $mimeBody, $matches);
        
        $boundary = trim($matches[1]);
    
        // Split the requests
        $requests = explode('--' . $boundary, $mimeBody);
        
        // Get the body of each request
        $result = array();
         
        // The first and last element are not request
        for ($i = 1; $i &lt; count($requests) - 1; $i++) {
            // Split the request header and body
            preg_match(&quot;/^.*?\r?\n\r?\n(.*)/s&quot;, $requests[$i], $matches);
            $result[] = $matches[1];
        }
        
        return $result;
    }
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>